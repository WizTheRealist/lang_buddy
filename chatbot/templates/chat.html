{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'assets/css/chat.css' %}">
    <title>LangBuddy</title>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="toggle-btn" onclick="toggleSidebar()">
                    <span id="toggle-icon">â—€</span>
                </button>
                <h2 class="app-title">LangBuddy</h2>
                <p class="app-subtitle">English Practice</p>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="{% url 'dashboard' %}" class="nav-link">
                        <span class="nav-icon">ðŸ“Š</span>
                        <span class="nav-text">Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link active">
                        <span class="nav-icon">ðŸ’¬</span>
                        <span class="nav-text">Practice Chat</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="document.getElementById('logout-form').submit(); return false;">
                        <span class="nav-icon">ðŸšª</span>
                        <span class="nav-text">Logout</span>
                    </a>
                    <form id="logout-form" method="post" action="{% url 'logout' %}" style="display: none;">
                        {% csrf_token %}
                    </form>
                </li>
            </ul>
        </nav>
        
        <!-- Mobile Overlay -->
        <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobileSidebar()"></div>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Header -->
            <header class="top-header">
                <div class="header-left">
                    <button class="mobile-toggle" onclick="openMobileSidebar()">â˜°</button>
                    <h1 class="page-title">Practice Chat</h1>
                </div>
                <div class="user-info">
                    <div class="user-avatar">{{ user.username.0|upper }}</div>
                    <span>{{ user.username }}</span>
                </div>
            </header>
            
            <!-- Chat Container -->
            <div class="chat-container">
                <div class="chat-header">
                    <span>{{ user.username|title }}'s {% if topics %}{{ topics|title }}{% endif %} lesson</span>
                </div>

                <div id="chat-box" class="chat-box">
                    {% for chat in chats %}
                        <div class="message user">{{ chat.user_message }}</div>
                        <div class="message ai">{{ chat.ai_reply }}</div>
                    {% endfor %}
                </div>

                <!-- Chat Form -->
                <form id="chat-form" class="chat-form">
                    {% csrf_token %}
                    <select id="topic-select" name="topics" required>
                        <option value="" disabled {% if not topics %}selected{% endif %}>-- Select Topic --</option>
                        <option value="travel" {% if topics == "travel" %}selected{% endif %}>Travel</option>
                        <option value="business" {% if topics == "business" %}selected{% endif %}>Business</option>
                        <option value="academic" {% if topics == "academic" %}selected{% endif %}>Academic</option>
                        <option value="conversational" {% if topics == "conversational" %}selected{% endif %}>Conversational</option>
                    </select>            
                    <textarea id="chat-message" placeholder="Type your message..." rows="1" required></textarea>
                    <button id="send-btn" type="submit" disabled>Send</button>
                </form>
            </div>
        </main>
    </div>

    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleIcon = document.getElementById('toggle-icon');
            
            sidebar.classList.toggle('collapsed');
            
            if (sidebar.classList.contains('collapsed')) {
                toggleIcon.textContent = 'â–¶';
            } else {
                toggleIcon.textContent = 'â—€';
            }
        }
        
        function openMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            sidebar.classList.add('mobile-open');
            overlay.classList.add('show');
        }
        
        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('show');
        }
        
        // Close mobile sidebar when clicking nav links
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', closeMobileSidebar);
        });

        // --- Expand textarea as the user types ---
        document.addEventListener("input", function (e) {
            if (e.target.tagName.toLowerCase() === "textarea") {
                e.target.style.height = "auto";
                e.target.style.height = e.target.scrollHeight + "px";
            }
        });
    
        // --- Allow Enter to send the message (without adding a new line) ---
        document.addEventListener("keydown", function (e) {
            if (e.target.tagName.toLowerCase() === "textarea") {
                if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById("chat-form").dispatchEvent(new Event("submit"));
                }
            }
        });
    
        // --- Disable the send button if textarea is empty ---
        const textarea = document.getElementById("chat-message");
        const sendBtn = document.getElementById("send-btn");
        textarea.addEventListener("input", () => {
            sendBtn.disabled = textarea.value.trim().length === 0;
        });
    
        // --- WebSocket connection setup ---
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const socket = new WebSocket(protocol + "//" + window.location.host + "/ws/chat/");
    
        // Get references to HTML elements we need
        const chatBox = document.getElementById("chat-box");
        const chatForm = document.getElementById("chat-form");
        const topicSelect = document.getElementById("topic-select");
    
        // Track current topic to detect changes
        let currentTopic = topicSelect.value;
        console.log('Initial topic from DOM:', currentTopic);
    
        // --- Handle topic changes ---
        topicSelect.addEventListener("change", function(e) {
            const newTopic = e.target.value;
            
            if (newTopic !== currentTopic) {
                currentTopic = newTopic;
                
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                fetch('/update_session_topic/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        topic: newTopic
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Session updated successfully:', data.topic);
                        
                        chatBox.innerHTML = '';
                        
                        socket.send(JSON.stringify({
                            action: 'reset_conversation',
                            topics: newTopic
                        }));
                        
                        setTimeout(() => {
                            window.location.reload();
                        }, 200);
                    }
                })
                .catch(error => {
                    console.error('Error updating session:', error);
                    window.location.reload();
                });
                
                console.log('Topic changed to:', newTopic);
            }
        });
    
        // --- Handle messages received from the server ---
        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
    
            if (data.error) {
                alert(data.error);
                return;
            }
            
            if (data.action === 'conversation_reset') {
                console.log('Conversation reset confirmed for topic:', data.topic);
                return;
            }
    
            if (data.ai_reply) {
                const aiMsg = document.createElement("div");
                aiMsg.classList.add("message", "ai");
                aiMsg.textContent = data.ai_reply;
                
                chatBox.appendChild(aiMsg);
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        };
    
        // --- Handle sending messages from the form ---
        chatForm.addEventListener("submit", function(e) {
            e.preventDefault();
    
            const message = textarea.value.trim();
            const topic = topicSelect.value;
    
            if (message && topic) {
                const userMsg = document.createElement("div");
                userMsg.classList.add("message", "user");
                userMsg.textContent = message;
                chatBox.appendChild(userMsg);
                
                chatBox.scrollTop = chatBox.scrollHeight;
                
                socket.send(JSON.stringify({
                    action: 'send_message',
                    message: message,
                    topics: topic
                }));
    
                textarea.value = "";
                sendBtn.disabled = true;
                textarea.style.height = "auto";
            }
        });
    </script>
</body>
</html>